# AGENTS.md

## Stack

TypeScript + Svelte 5, SvelteKit, Tailwind CSS v4, Vitest, pnpm (frontend).
Julia 1.12 + Oxygen.jl, HTTP.jl (backend API server).

## Commands

```bash
pnpm install          # install deps
pnpm run dev          # dev server
pnpm run build        # production build
pnpm run check        # svelte-check + tsc — run after editing TS/Svelte files
pnpm run lint         # ESLint
pnpm run format       # Prettier (write)
pnpm run test         # run all tests
```

## Code Style

- Tabs, single quotes, no trailing commas, 100-char line width (Prettier)
- Named imports; `$lib` alias for `src/lib/`, `$app/*` for SvelteKit runtime
- `camelCase` vars/functions, `PascalCase` components/types, `UPPER_SNAKE_CASE` constants
- Svelte 5 runes: `$state()`, `$derived()`, `$effect()`, `$props()`; `{@render children()}` not `<slot />`
- TypeScript strict mode; avoid `any`, use `unknown`
- SvelteKit error handling: `error()` from `@sveltejs/kit`, never swallow errors silently

## Testing

- Test files in `src/tests/` or co-located as `*.test.ts`
- `@testing-library/svelte` with `render()` and `screen`; jest-dom matchers available globally

## Project Structure

```
src/
  lib/          # shared code ($lib alias)
  routes/       # file-based routing (+page.svelte, +layout.svelte, etc.)
  tests/        # unit/component tests
static/         # public assets
server/         # Julia HTTP server (Oxygen.jl); routes in server/src/Server.jl
julia-mcp/      # git submodule — aplavin/julia-mcp (MCP server for julia_eval)
opencode.jsonc  # OpenCode config — registers julia-mcp and Svelte MCP plugin
```

## Notes

- Never edit `.svelte-kit/` (auto-generated)
- Never edit `server/Manifest.toml` by hand (auto-generated by `Pkg`)
- `pnpm run dev` starts both Vite and Julia concurrently; edits to `server/src/Server.jl` are hot-reloaded via Revise
- The `julia` MCP tool (from `julia-mcp/`) gives the agent `julia_eval()` access to a persistent Julia REPL session
- The `@sveltejs/opencode` plugin provides the Svelte MCP server, skills, and a `svelte-file-editor` subagent

## Svelte MCP

The Svelte MCP server (`@sveltejs/opencode` plugin) provides documentation lookup, code analysis, and a specialized subagent for writing Svelte code.

### Available tools

1. **list-sections** — Lists all available Svelte 5 and SvelteKit documentation sections. Use this FIRST to discover relevant sections when working on Svelte/SvelteKit tasks.
2. **get-documentation** — Retrieves full documentation for specific sections. After calling `list-sections`, fetch ALL sections relevant to the current task.
3. **svelte-autofixer** — Analyzes Svelte code and returns issues and suggestions. MUST be run on any generated or edited Svelte code before finalizing. Keep calling until no issues remain.
4. **playground-link** — Generates a Svelte Playground link with provided code. Only use when code is not written to project files and the user confirms they want a link.

### Workflow

- When uncertain about Svelte 5 syntax or SvelteKit APIs, run `list-sections` then `get-documentation`
- Always validate generated `.svelte` files with `svelte-autofixer` before finalizing
- The `svelte-file-editor` subagent is automatically available for creating/editing `.svelte` files with its own context window

## Julia Backend

The Julia server (Oxygen.jl) runs on port 8080 and is proxied by Vite at `/api/*` (the `/api` prefix is stripped before reaching Julia).

### Route registration

The `Server` module uses Oxygen's `@oxidize` macro, which creates module-scoped state so route macros (`@get`, `@post`, etc.) work correctly at module top-level. Define new routes directly in `server/src/Server.jl`:

```julia
module Server

using Oxygen; @oxidize
using HTTP

@get "/my-route" function(req::HTTP.Request)
    return json(Dict("key" => "value"))
end

end
```

Use `json()` for JSON responses. Path parameters use braces: `"/items/{id}"`.

### Hot reload (development)

`server/debug.jl` loads `Revise` before `using Server` so Revise automatically tracks the `Server` module. It calls `Server.serve(revise=:eager)` to leverage Oxygen's built-in Revise integration, which re-evaluates changed source files eagerly as they are saved.

`server/run.jl` omits Revise for production (no overhead).

### Julia code style

- 4-space indentation (Julia community convention)
- `snake_case` for functions and variables
- `PascalCase` for types/modules
- Prefer explicit types on handler arguments (`n::Int`, `req::HTTP.Request`)
